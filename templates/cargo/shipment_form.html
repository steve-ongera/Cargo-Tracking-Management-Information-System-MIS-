{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }} - Cargo Tracking MIS{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<style>
    :root {
        --primary-color: #4e73df;
        --primary-hover: #2e59d9;
        --success-color: #1cc88a;
        --warning-color: #f6c23e;
        --danger-color: #e74a3b;
        --info-color: #36b9cc;
        --light-bg: #f8f9fc;
        --border-color: #e3e6f0;
        --text-muted: #858796;
    }
    
    body {
        background-color: #f8f9fc;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .breadcrumb-custom {
        background: white;
        padding: 15px 20px;
        margin-bottom: 20px;
        font-size: 0.9rem;
        border-radius: 8px;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    }
    
    .breadcrumb-custom a {
        color: var(--primary-color);
        text-decoration: none;
    }
    
    .breadcrumb-custom a:hover {
        text-decoration: underline;
    }
    
    .page-header {
        background: white;
        border-radius: 8px;
        padding: 25px;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        margin-bottom: 30px;
    }
    
    .form-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        overflow: hidden;
    }
    
    .form-section {
        padding: 25px;
        border-bottom: 2px solid var(--light-bg);
    }
    
    .form-section:last-child {
        border-bottom: none;
    }
    
    .section-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--light-bg);
    }
    
    .section-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        color: white;
    }
    
    .section-icon.primary { background: var(--primary-color); }
    .section-icon.success { background: var(--success-color); }
    .section-icon.warning { background: var(--warning-color); }
    .section-icon.info { background: var(--info-color); }
    
    .section-title {
        font-size: 18px;
        font-weight: 600;
        color: #111827;
        margin: 0;
    }
    
    .section-subtitle {
        font-size: 13px;
        color: var(--text-muted);
        margin: 0;
    }
    
    .form-label {
        font-weight: 600;
        color: #5a5c69;
        font-size: 14px;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .form-label .required {
        color: var(--danger-color);
    }
    
    .form-control, .form-select {
        padding: 12px 16px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 14px;
        transition: all 0.2s;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.15);
        outline: none;
    }
    
    .form-text {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 5px;
    }
    
    .input-group-text {
        background: var(--light-bg);
        border: 1px solid var(--border-color);
        color: var(--text-muted);
        font-weight: 600;
        font-size: 13px;
    }
    
    .btn {
        padding: 12px 24px;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
        border: none;
        cursor: pointer;
        font-size: 14px;
    }
    
    .btn-primary {
        background: var(--primary-color);
        color: white;
    }
    
    .btn-primary:hover {
        background: var(--primary-hover);
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(78, 115, 223, 0.3);
    }
    
    .btn-secondary {
        background: #858796;
        color: white;
    }
    
    .btn-secondary:hover {
        background: #6e707e;
        color: white;
    }
    
    .btn-success {
        background: var(--success-color);
        color: white;
    }
    
    .btn-success:hover {
        background: #17a673;
        transform: translateY(-1px);
    }
    
    .alert {
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        border: none;
    }
    
    .alert-info {
        background: #dbeafe;
        color: #1e40af;
    }
    
    .alert-warning {
        background: #fef3c7;
        color: #92400e;
    }
    
    .alert i {
        font-size: 1.5rem;
    }
    
    .form-actions {
        background: var(--light-bg);
        padding: 20px 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 15px;
        flex-wrap: wrap;
    }
    
    .priority-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        margin-left: 10px;
    }
    
    .priority-low { background: #e0e7ff; color: #3730a3; }
    .priority-medium { background: #fef3c7; color: #92400e; }
    .priority-high { background: #fed7aa; color: #9a3412; }
    .priority-urgent { background: #fecaca; color: #991b1b; }
    
    .info-card {
        background: var(--light-bg);
        border-left: 4px solid var(--info-color);
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
    }
    
    .info-card-title {
        font-weight: 600;
        color: #111827;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .info-card-text {
        font-size: 13px;
        color: var(--text-muted);
        margin: 0;
    }
    
    @media (max-width: 768px) {
        .form-section {
            padding: 20px;
        }
        
        .section-header {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .form-actions {
            flex-direction: column;
        }
        
        .btn {
            width: 100%;
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Breadcrumb -->
    <div class="breadcrumb-custom">
        <a href="{% url 'dashboard' %}"><i class="bi bi-house-door"></i> Home</a>
        <span class="mx-2">/</span>
        <a href="{% url 'cargo_list' %}">Shipments</a>
        <span class="mx-2">/</span>
        <span>{{ page_title }}</span>
    </div>
    
    <!-- Page Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div>
                <h1 class="h3 mb-2">
                    <i class="bi {% if is_edit %}bi-pencil-square{% else %}bi-plus-circle{% endif %} text-primary me-2"></i>
                    {{ page_title }}
                </h1>
                <p class="text-muted mb-0">
                    {% if is_edit %}
                        Update shipment details and track changes
                    {% else %}
                        Create a new cargo shipment and start tracking
                    {% endif %}
                </p>
            </div>
            {% if is_edit %}
            <div>
                <a href="{% url 'cargo_detail' cargo.id %}" class="btn btn-secondary">
                    <i class="bi bi-eye"></i> View Details
                </a>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Info Alert -->
    {% if is_edit %}
    <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle"></i>
        <div>
            <strong>Editing Shipment {{ cargo.cargo_id }}</strong><br>
            <small>Changes will be tracked in the audit history. Status: <strong>{{ cargo.get_status_display }}</strong></small>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i>
        <div>
            <strong>New Shipment Creation:</strong> Fill in all required fields marked with <span class="text-danger">*</span>. A unique tracking number will be generated automatically.
        </div>
    </div>
    {% endif %}
    
    <!-- Form -->
    <form method="POST" id="shipmentForm">
        {% csrf_token %}
        
        <div class="form-container">
            <!-- Section 1: Basic Information -->
            <div class="form-section">
                <div class="section-header">
                    <div class="section-icon primary">
                        <i class="bi bi-info-circle"></i>
                    </div>
                    <div>
                        <h2 class="section-title">Basic Information</h2>
                        <p class="section-subtitle">Supplier, warehouse, and cargo category details</p>
                    </div>
                </div>
                
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="supplier" class="form-label">
                            Supplier <span class="required">*</span>
                        </label>
                        <select class="form-select" id="supplier" name="supplier" required>
                            <option value="">Select Supplier</option>
                            {% for supplier in suppliers %}
                            <option value="{{ supplier.id }}" 
                                {% if is_edit and cargo.supplier.id == supplier.id %}selected{% endif %}>
                                {{ supplier.supplier_id }} - {{ supplier.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Choose the supplier providing the cargo</div>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="warehouse" class="form-label">
                            Destination Warehouse <span class="required">*</span>
                        </label>
                        <select class="form-select" id="warehouse" name="warehouse" required>
                            <option value="">Select Warehouse</option>
                            {% for warehouse in warehouses %}
                            <option value="{{ warehouse.id }}" 
                                {% if is_edit and cargo.warehouse.id == warehouse.id %}selected{% endif %}>
                                {{ warehouse.warehouse_id }} - {{ warehouse.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Final destination for the cargo</div>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="category" class="form-label">
                            Cargo Category <span class="required">*</span>
                        </label>
                        <select class="form-select" id="category" name="category" required>
                            <option value="">Select Category</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}" 
                                {% if is_edit and cargo.category.id == category.id %}selected{% endif %}>
                                {{ category.code }} - {{ category.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Type of cargo being shipped</div>
                    </div>
                </div>
            </div>
            
            <!-- Section 2: Cargo Details -->
            <div class="form-section">
                <div class="section-header">
                    <div class="section-icon success">
                        <i class="bi bi-box-seam"></i>
                    </div>
                    <div>
                        <h2 class="section-title">Cargo Details</h2>
                        <p class="section-subtitle">Description, quantity, and measurements</p>
                    </div>
                </div>
                
                <div class="row g-3">
                    <div class="col-12">
                        <label for="description" class="form-label">
                            Cargo Description <span class="required">*</span>
                        </label>
                        <textarea class="form-control" id="description" name="description" rows="3" required>{% if is_edit %}{{ cargo.description }}{% endif %}</textarea>
                        <div class="form-text">Detailed description of the goods being shipped</div>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="quantity" class="form-label">
                            Quantity <span class="required">*</span>
                        </label>
                        <input type="number" class="form-control" id="quantity" name="quantity" 
                               min="1" required value="{% if is_edit %}{{ cargo.quantity }}{% endif %}">
                    </div>
                    
                    <div class="col-md-4">
                        <label for="unit_of_measurement" class="form-label">
                            Unit of Measurement <span class="required">*</span>
                        </label>
                        <select class="form-select" id="unit_of_measurement" name="unit_of_measurement" required>
                            {% for unit in units_of_measurement %}
                            <option value="{{ unit }}" 
                                {% if is_edit and cargo.unit_of_measurement == unit %}selected{% endif %}>
                                {{ unit }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="weight_kg" class="form-label">
                            Weight (KG) <span class="required">*</span>
                        </label>
                        <input type="number" class="form-control" id="weight_kg" name="weight_kg" 
                               step="0.01" min="0.01" required value="{% if is_edit %}{{ cargo.weight_kg }}{% endif %}">
                    </div>
                    
                    <div class="col-md-6">
                        <label for="volume_cbm" class="form-label">
                            Volume (Cubic Meters)
                        </label>
                        <input type="number" class="form-control" id="volume_cbm" name="volume_cbm" 
                               step="0.01" min="0.01" value="{% if is_edit %}{{ cargo.volume_cbm }}{% endif %}">
                        <div class="form-text">Optional - if applicable</div>
                    </div>
                </div>
            </div>
            
            <!-- Section 3: Valuation -->
            <div class="form-section">
                <div class="section-header">
                    <div class="section-icon warning">
                        <i class="bi bi-currency-exchange"></i>
                    </div>
                    <div>
                        <h2 class="section-title">Valuation</h2>
                        <p class="section-subtitle">Cargo value and insurance information</p>
                    </div>
                </div>
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="declared_value" class="form-label">
                            Declared Value (KES) <span class="required">*</span>
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">KES</span>
                            <input type="number" class="form-control" id="declared_value" name="declared_value" 
                                   step="0.01" min="0" required value="{% if is_edit %}{{ cargo.declared_value }}{% endif %}">
                        </div>
                        <div class="form-text">Total value of the cargo in Kenyan Shillings</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="insurance_value" class="form-label">
                            Insurance Value (KES)
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">KES</span>
                            <input type="number" class="form-control" id="insurance_value" name="insurance_value" 
                                   step="0.01" min="0" value="{% if is_edit %}{{ cargo.insurance_value }}{% endif %}">
                        </div>
                        <div class="form-text">Optional - if cargo is insured</div>
                    </div>
                </div>
            </div>
            
            <!-- Section 4: Shipment Schedule -->
            <div class="form-section">
                <div class="section-header">
                    <div class="section-icon info">
                        <i class="bi bi-calendar-event"></i>
                    </div>
                    <div>
                        <h2 class="section-title">Shipment Schedule</h2>
                        <p class="section-subtitle">Dispatch and expected arrival dates</p>
                    </div>
                </div>
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="dispatch_date" class="form-label">
                            Dispatch Date & Time <span class="required">*</span>
                        </label>
                        <input type="datetime-local" class="form-control" id="dispatch_date" name="dispatch_date" 
                               required value="{% if is_edit %}{{ cargo.dispatch_date|date:'Y-m-d\TH:i' }}{% endif %}">
                        <div class="form-text">When the cargo was/will be dispatched</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="expected_arrival_date" class="form-label">
                            Expected Arrival Date & Time <span class="required">*</span>
                        </label>
                        <input type="datetime-local" class="form-control" id="expected_arrival_date" name="expected_arrival_date" 
                               required value="{% if is_edit %}{{ cargo.expected_arrival_date|date:'Y-m-d\TH:i' }}{% endif %}">
                        <div class="form-text">Expected arrival at destination warehouse</div>
                    </div>
                </div>
            </div>
            
            <!-- Section 5: Transport Details -->
            <div class="form-section">
                <div class="section-header">
                    <div class="section-icon primary">
                        <i class="bi bi-truck"></i>
                    </div>
                    <div>
                        <h2 class="section-title">Transport Details</h2>
                        <p class="section-subtitle">Mode of transport and driver information</p>
                    </div>
                </div>
                
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="transport_mode" class="form-label">
                            Transport Mode <span class="required">*</span>
                        </label>
                        <select class="form-select" id="transport_mode" name="transport_mode" required>
                            {% for mode_value, mode_label in transport_modes %}
                            <option value="{{ mode_value }}" 
                                {% if is_edit and cargo.transport_mode == mode_value %}selected{% elif not is_edit and mode_value == 'ROAD' %}selected{% endif %}>
                                {{ mode_label }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="vehicle_registration" class="form-label">
                            Vehicle/Container Registration
                        </label>
                        <input type="text" class="form-control" id="vehicle_registration" name="vehicle_registration" 
                               placeholder="e.g., KCA 123A" style="text-transform: uppercase;" 
                               value="{% if is_edit %}{{ cargo.vehicle_registration }}{% endif %}">
                        <div class="form-text">Vehicle reg or container number</div>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="priority" class="form-label">
                            Priority <span class="required">*</span>
                        </label>
                        <select class="form-select" id="priority" name="priority" required>
                            {% for priority_value, priority_label in priority_choices %}
                            <option value="{{ priority_value }}" 
                                {% if is_edit and cargo.priority == priority_value %}selected{% elif not is_edit and priority_value == 'MEDIUM' %}selected{% endif %}>
                                {{ priority_label }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="driver_name" class="form-label">
                            Driver Name
                        </label>
                        <input type="text" class="form-control" id="driver_name" name="driver_name" 
                               placeholder="Full name of driver" value="{% if is_edit %}{{ cargo.driver_name }}{% endif %}">
                    </div>
                    
                    <div class="col-md-6">
                        <label for="driver_phone" class="form-label">
                            Driver Phone Number
                        </label>
                        <input type="tel" class="form-control" id="driver_phone" name="driver_phone" 
                               placeholder="+254712345678" pattern="^\+254[17]\d{8}$" 
                               value="{% if is_edit %}{{ cargo.driver_phone }}{% endif %}">
                        <div class="form-text">Format: +254712345678</div>
                    </div>
                </div>
            </div>
            
            <!-- Section 6: Documentation -->
            <div class="form-section">
                <div class="section-header">
                    <div class="section-icon success">
                        <i class="bi bi-file-earmark-text"></i>
                    </div>
                    <div>
                        <h2 class="section-title">Documentation</h2>
                        <p class="section-subtitle">Purchase order, invoice, and delivery note references</p>
                    </div>
                </div>
                
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="purchase_order_number" class="form-label">
                            Purchase Order Number
                        </label>
                        <input type="text" class="form-control" id="purchase_order_number" name="purchase_order_number" 
                               placeholder="PO-XXXXX" value="{% if is_edit %}{{ cargo.purchase_order_number }}{% endif %}">
                    </div>
                    
                    <div class="col-md-4">
                        <label for="invoice_number" class="form-label">
                            Invoice Number
                        </label>
                        <input type="text" class="form-control" id="invoice_number" name="invoice_number" 
                               placeholder="INV-XXXXX" value="{% if is_edit %}{{ cargo.invoice_number }}{% endif %}">
                    </div>
                    
                    <div class="col-md-4">
                        <label for="delivery_note_number" class="form-label">
                            Delivery Note Number
                        </label>
                        <input type="text" class="form-control" id="delivery_note_number" name="delivery_note_number" 
                               placeholder="DN-XXXXX" value="{% if is_edit %}{{ cargo.delivery_note_number }}{% endif %}">
                    </div>
                </div>
            </div>
            
            <!-- Section 7: Additional Information -->
            <div class="form-section">
                <div class="section-header">
                    <div class="section-icon warning">
                        <i class="bi bi-card-text"></i>
                    </div>
                    <div>
                        <h2 class="section-title">Additional Information</h2>
                        <p class="section-subtitle">Special instructions and notes</p>
                    </div>
                </div>
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="special_instructions" class="form-label">
                            Special Instructions
                        </label>
                        <textarea class="form-control" id="special_instructions" name="special_instructions" rows="4" 
                                  placeholder="Any special handling requirements or delivery instructions">{% if is_edit %}{{ cargo.special_instructions }}{% endif %}</textarea>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="notes" class="form-label">
                            Internal Notes
                        </label>
                        <textarea class="form-control" id="notes" name="notes" rows="4" 
                                  placeholder="Internal notes (not visible to suppliers)">{% if is_edit %}{{ cargo.notes }}{% endif %}</textarea>
                    </div>
                </div>
            </div>
            
            {% if is_edit %}
            <!-- Section 8: Status Update (Edit Only) -->
            <div class="form-section">
                <div class="section-header">
                    <div class="section-icon info">
                        <i class="bi bi-arrow-repeat"></i>
                    </div>
                    <div>
                        <h2 class="section-title">Status Update</h2>
                        <p class="section-subtitle">Update shipment status if needed</p>
                    </div>
                </div>
                
                <div class="info-card">
                    <div class="info-card-title">
                        <i class="bi bi-info-circle text-info"></i>
                        Current Status: <strong>{{ cargo.get_status_display }}</strong>
                    </div>
                    <p class="info-card-text">
                        Change the status only if there's a legitimate update. Status changes are tracked in the audit history.
                    </p>
                </div>
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="status" class="form-label">
                            Update Status
                        </label>
                        <select class="form-select" id="status" name="status">
                            <option value="">Keep Current Status</option>
                            {% for status_value, status_label in status_choices %}
                            <option value="{{ status_value }}" 
                                {% if cargo.status == status_value %}selected{% endif %}>
                                {{ status_label }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="status_change_reason" class="form-label">
                            Reason for Status Change
                        </label>
                        <input type="text" class="form-control" id="status_change_reason" name="status_change_reason" 
                               placeholder="Brief reason for the status update">
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Form Actions -->
            <div class="form-actions">
                <a href="{% if is_edit %}{% url 'cargo_detail' cargo.id %}{% else %}{% url 'cargo_list' %}{% endif %}" 
                   class="btn btn-secondary">
                    <i class="bi bi-x-circle"></i> Cancel
                </a>
                
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-success">
                        <i class="bi {% if is_edit %}bi-check-circle{% else %}bi-plus-circle{% endif %}"></i>
                        {% if is_edit %}Update Shipment{% else %}Create Shipment{% endif %}
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Form validation and enhancement
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('shipmentForm');
        
        // Auto-uppercase vehicle registration
        const vehicleReg = document.getElementById('vehicle_registration');
        if (vehicleReg) {
            vehicleReg.addEventListener('input', function(e) {
                e.target.value = e.target.value.toUpperCase();
            });
        }
        
        // Validate dispatch date is not in the future for new shipments
        const dispatchDate = document.getElementById('dispatch_date');
        const expectedArrival = document.getElementById('expected_arrival_date');
        
        if (dispatchDate && expectedArrival) {
            dispatchDate.addEventListener('change', function() {
                const dispatch = new Date(this.value);
                const arrival = new Date(expectedArrival.value);
                
                // Ensure expected arrival is after dispatch
                if (arrival && dispatch >= arrival) {
                    alert('Expected arrival date must be after dispatch date');
                    expectedArrival.value = '';
                }
            });
            
            expectedArrival.addEventListener('change', function() {
                const dispatch = new Date(dispatchDate.value);
                const arrival = new Date(this.value);
                
                if (dispatch && arrival <= dispatch) {
                    alert('Expected arrival date must be after dispatch date');
                    this.value = '';
                }
            });
        }
        
        // Priority indicator
        const prioritySelect = document.getElementById('priority');
        if (prioritySelect) {
            prioritySelect.addEventListener('change', function() {
                updatePriorityIndicator(this.value);
            });
            
            // Initialize on page load
            updatePriorityIndicator(prioritySelect.value);
        }
        
        function updatePriorityIndicator(priority) {
            const existingBadge = document.querySelector('.priority-badge');
            if (existingBadge) {
                existingBadge.remove();
            }
            
            const label = prioritySelect.parentElement.querySelector('.form-label');
            let badgeClass = 'priority-low';
            let icon = 'bi-dash-circle';
            
            if (priority === 'MEDIUM') {
                badgeClass = 'priority-medium';
                icon = 'bi-exclamation-circle';
            } else if (priority === 'HIGH') {
                badgeClass = 'priority-high';
                icon = 'bi-exclamation-triangle';
            } else if (priority === 'URGENT') {
                badgeClass = 'priority-urgent';
                icon = 'bi-exclamation-octagon';
            }
            
            const badge = document.createElement('span');
            badge.className = `priority-badge ${badgeClass}`;
            badge.innerHTML = `<i class="bi ${icon}"></i> ${priority}`;
            label.appendChild(badge);
        }
        
        // Form submission confirmation for high priority
        form.addEventListener('submit', function(e) {
            const priority = document.getElementById('priority').value;
            
            if (priority === 'URGENT' || priority === 'HIGH') {
                const confirmed = confirm(
                    `You are creating a ${priority} priority shipment. This will generate alerts for warehouse staff. Continue?`
                );
                
                if (!confirmed) {
                    e.preventDefault();
                }
            }
        });
        
        // Calculate estimated delivery time
        if (dispatchDate && expectedArrival) {
            function calculateDeliveryTime() {
                const dispatch = new Date(dispatchDate.value);
                const arrival = new Date(expectedArrival.value);
                
                if (dispatch && arrival && arrival > dispatch) {
                    const diffMs = arrival - dispatch;
                    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                    const diffDays = Math.floor(diffHours / 24);
                    const remainingHours = diffHours % 24;
                    
                    let timeText = '';
                    if (diffDays > 0) {
                        timeText = `${diffDays} day${diffDays > 1 ? 's' : ''}`;
                        if (remainingHours > 0) {
                            timeText += ` ${remainingHours} hour${remainingHours > 1 ? 's' : ''}`;
                        }
                    } else {
                        timeText = `${diffHours} hour${diffHours > 1 ? 's' : ''}`;
                    }
                    
                    // Show delivery time estimate
                    let estimateDiv = document.getElementById('delivery-estimate');
                    if (!estimateDiv) {
                        estimateDiv = document.createElement('div');
                        estimateDiv.id = 'delivery-estimate';
                        estimateDiv.className = 'info-card mt-3';
                        expectedArrival.parentElement.appendChild(estimateDiv);
                    }
                    
                    estimateDiv.innerHTML = `
                        <div class="info-card-title">
                            <i class="bi bi-clock-history text-info"></i>
                            Estimated Delivery Time
                        </div>
                        <p class="info-card-text">
                            <strong>${timeText}</strong> from dispatch to expected arrival
                        </p>
                    `;
                }
            }
            
            dispatchDate.addEventListener('change', calculateDeliveryTime);
            expectedArrival.addEventListener('change', calculateDeliveryTime);
            
            // Calculate on page load if both dates are set
            if (dispatchDate.value && expectedArrival.value) {
                calculateDeliveryTime();
            }
        }
        
        // Phone number formatting
        const driverPhone = document.getElementById('driver_phone');
        if (driverPhone) {
            driverPhone.addEventListener('blur', function() {
                let phone = this.value.trim();
                
                // Auto-format Kenyan phone numbers
                if (phone && !phone.startsWith('+')) {
                    if (phone.startsWith('0')) {
                        phone = '+254' + phone.substring(1);
                    } else if (phone.startsWith('254')) {
                        phone = '+' + phone;
                    } else if (phone.length === 9) {
                        phone = '+254' + phone;
                    }
                    this.value = phone;
                }
            });
        }
        
        // Supplier change - load supplier details (optional enhancement)
        const supplierSelect = document.getElementById('supplier');
        if (supplierSelect) {
            supplierSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption.value) {
                    console.log('Supplier selected:', selectedOption.text);
                    // You could add AJAX call here to fetch supplier details
                }
            });
        }
        
        // Warehouse change - show warehouse details (optional enhancement)
        const warehouseSelect = document.getElementById('warehouse');
        if (warehouseSelect) {
            warehouseSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption.value) {
                    console.log('Warehouse selected:', selectedOption.text);
                    // You could add AJAX call here to fetch warehouse details
                }
            });
        }
        
        // Mark required fields that are empty
        const requiredFields = form.querySelectorAll('[required]');
        requiredFields.forEach(field => {
            field.addEventListener('invalid', function() {
                this.classList.add('is-invalid');
            });
            
            field.addEventListener('input', function() {
                if (this.value) {
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                }
            });
        });
        
        // Smooth scroll to first error on form submission
        form.addEventListener('invalid', function(e) {
            e.preventDefault();
            const firstInvalid = form.querySelector(':invalid');
            if (firstInvalid) {
                firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstInvalid.focus();
            }
        }, true);
    });
</script>
{% endblock %}