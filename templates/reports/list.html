{% extends 'base.html' %}
{% load static %}

{% block title %}Reports List{% endblock %}

{% block extra_css %}
<style>
    .stats-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .stats-card h3 {
        color: #333;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 10px;
        text-transform: uppercase;
    }
    
    .stats-value {
        font-size: 32px;
        font-weight: bold;
        color: #2563eb;
    }
    
    .chart-container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .chart-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 15px;
        color: #333;
    }
    
    .reports-table {
        width: 100%;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .reports-table th {
        background: #f3f4f6;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #374151;
    }
    
    .reports-table td {
        padding: 12px;
        border-top: 1px solid #e5e7eb;
    }
    
    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 12px;
        text-transform: capitalize;
    }
    
    .status-completed { background: #dcfce7; color: #166534; }
    .status-pending { background: #fef3c7; color: #92400e; }
    .status-processing { background: #dbeafe; color: #1e40af; }
    .status-failed { background: #fee2e2; color: #991b1b; }
    
    .btn {
        padding: 8px 16px;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 500;
        display: inline-block;
        transition: all 0.2s;
    }
    
    .btn-primary {
        background: #2563eb;
        color: white;
    }
    
    .btn-primary:hover {
        background: #1d4ed8;
    }
    
    .btn-secondary {
        background: #6b7280;
        color: white;
    }
    
    .btn-secondary:hover {
        background: #4b5563;
    }
    
    .action-buttons {
        display: flex;
        gap: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container" style="max-width: 1400px; margin: 0 auto; padding: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h1 style="font-size: 28px; font-weight: bold; color: #111827;">
            Reports Dashboard
        </h1>
        <a href="{% url 'reports:create' %}" class="btn btn-primary">
            + Generate New Report
        </a>
    </div>
    
    <!-- Statistics Cards -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div class="stats-card">
            <h3>Total Reports</h3>
            <div class="stats-value">{{ total_reports }}</div>
        </div>
        <div class="stats-card">
            <h3>Completed Reports</h3>
            <div class="stats-value">{{ completed_reports }}</div>
        </div>
        <div class="stats-card">
            <h3>Pending Reports</h3>
            <div class="stats-value">{{ pending_reports }}</div>
        </div>
        <div class="stats-card">
            <h3>Success Rate</h3>
            <div class="stats-value">
                {% if total_reports > 0 %}
                    {{ completed_reports|floatformat:0 }}%
                {% else %}
                    0%
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Charts Row -->
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 30px;">
        <div class="chart-container">
            <div class="chart-title">Reports by Type</div>
            <canvas id="reportTypeChart"></canvas>
        </div>
        <div class="chart-container">
            <div class="chart-title">Reports by Status</div>
            <canvas id="statusChart"></canvas>
        </div>
        <div class="chart-container">
            <div class="chart-title">Generation Trend</div>
            <canvas id="trendChart"></canvas>
        </div>
    </div>
    
    <!-- Reports Table -->
    <div>
        <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 15px; color: #111827;">
            All Reports
        </h2>
        <table class="reports-table">
            <thead>
                <tr>
                    <th>Report ID</th>
                    <th>Report Type</th>
                    <th>Title</th>
                    <th>Status</th>
                    <th>Created Date</th>
                    <th>Generated By</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for report in reports %}
                <tr>
                    <td>#{{ report.id }}</td>
                    <td>{{ report.get_report_type_display }}</td>
                    <td>{{ report.title }}</td>
                    <td>
                        <span class="status-badge status-{{ report.status }}">
                            {{ report.status }}
                        </span>
                    </td>
                    <td>{{ report.created_at|date:"M d, Y H:i" }}</td>
                    <td>{{ report.generated_by.get_full_name|default:report.generated_by.username }}</td>
                    <td>
                        <div class="action-buttons">
                            <a href="{% url 'reports:detail' report.id %}" class="btn btn-primary" style="font-size: 12px; padding: 6px 12px;">
                                View
                            </a>
                            {% if report.file_path %}
                            <a href="{{ report.file_path.url }}" class="btn btn-secondary" style="font-size: 12px; padding: 6px 12px;" download>
                                Download
                            </a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" style="text-align: center; padding: 40px; color: #6b7280;">
                        No reports found. Generate your first report to get started!
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // Parse data from Django
    const typeChartData = JSON.parse('{{ type_chart_data|safe }}');
    const timelineData = JSON.parse('{{ timeline_data|safe }}');
    const statusData = JSON.parse('{{ status_data|safe }}');
    
    // Chart 1: Reports by Type
    new Chart(document.getElementById('reportTypeChart'), {
        type: 'doughnut',
        data: {
            labels: typeChartData.labels,
            datasets: [{
                data: typeChartData.counts,
                backgroundColor: [
                    '#2563eb',
                    '#10b981',
                    '#f59e0b',
                    '#ef4444',
                    '#8b5cf6',
                    '#ec4899'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 10,
                        font: { size: 11 }
                    }
                }
            }
        }
    });
    
    // Chart 2: Reports by Status
    new Chart(document.getElementById('statusChart'), {
        type: 'pie',
        data: {
            labels: statusData.labels,
            datasets: [{
                data: statusData.counts,
                backgroundColor: [
                    '#10b981',
                    '#f59e0b',
                    '#3b82f6',
                    '#ef4444'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 10,
                        font: { size: 11 }
                    }
                }
            }
        }
    });
    
    // Chart 3: Timeline
    new Chart(document.getElementById('trendChart'), {
        type: 'line',
        data: {
            labels: timelineData.labels,
            datasets: [{
                label: 'Reports Generated',
                data: timelineData.counts,
                borderColor: '#2563eb',
                backgroundColor: 'rgba(37, 99, 235, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { stepSize: 1 }
                }
            }
        }
    });
</script>
{% endblock %}